<!DOCTYPE html>
<html>

<head>
    <title>
        Video Streaming
    </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dashjs/4.5.0/dash.all.min.js" type="text/javascript"></script>
</head>

<body>
    Hello
    <video id="video" width="420" height="auto" controls></video>
    <script type="text/javascript">
        console.log('Ready')


        var url = "/vp9/dash.mpd";
        var player = dashjs.MediaPlayer().create();
        player.initialize(document.getElementById("video"), url, true);

        //var arrayOfBlobs = []
        /*var index=0
        setInterval(async function () {
            if(index===null) return
            //return
            console.log(typeof arrayOfBlobs)
            var api = await fetch(`/video/test/${index}`)
            if(api.status!==200) {
                index=null
                return
            }
            var data = await api.json()
            console.log(typeof data)
            index=data.next
            arrayOfBlobs.push(data.data);
            // NEW: Try to flush our queue of video data to the video element
            appendToSourceBuffer();
        }, 200);*/

        // 1. Create a `MediaSource`
        /*var mediaSource = new MediaSource();

        // 2. Create an object URL from the `MediaSource`
        var url = URL.createObjectURL(mediaSource);

        // 3. Set the video's `src` to the object URL
        var video = document.getElementById("video");
        video.src = url;

        // 4. On the `sourceopen` event, create a `SourceBuffer`
        var sourceBuffer = null;*/




        /*mediaSource.addEventListener('sourceopen', function (e) {
            //video.play();

            sourceBuffer = mediaSource.addSourceBuffer('video/mp4; codecs="avc1.640028,mp4a.40.2"');

            sourceBuffer.addEventListener('updatestart', function (e) { console.log('updatestart: ' + mediaSource.readyState); });
            sourceBuffer.addEventListener('update', function (e) { console.log('update: ' + mediaSource.readyState); });
            sourceBuffer.addEventListener('updateend', function (e) { console.log('updateend: ' + mediaSource.readyState); });
            sourceBuffer.addEventListener('error', function (e) { console.log('error: ' + mediaSource.readyState); });
            sourceBuffer.addEventListener('abort', function (e) { console.log('abort: ' + mediaSource.readyState); });

            sourceBuffer.addEventListener('update', function () { // Note: Have tried 'updateend'
                if (queue.length > 0 && !buffer.updating) {
                    sourceBuffer.appendBuffer(arrayOfBlobs.shift());
                }
            });
        }, false);

        mediaSource.addEventListener('sourceopen', function (e) { console.log('sourceopen: ' + mediaSource.readyState); });
        mediaSource.addEventListener('sourceended', function (e) { console.log('sourceended: ' + mediaSource.readyState); });
        mediaSource.addEventListener('sourceclose', function (e) { console.log('sourceclose: ' + mediaSource.readyState); });
        mediaSource.addEventListener('error', function (e) { console.log('error: ' + mediaSource.readyState); });

        function getData(index) {
            fetch(`/video/test/${index}`)
                .then(res => {
                    if (res.status !== 200) return null
                    else return res.arrayBuffer()
                })
                .then(data => {
                    if (data === null) return
                    arrayOfBlobs.push(data)
                    if (!sourceBuffer.updating && arrayOfBlobs.length > 0)
                        sourceBuffer.appendBuffer(data)
                    getData(index + 1)
                })
        }
        getData(0)*/
















        /*mediaSource.addEventListener("sourceopen", function () {
            // NOTE: Browsers are VERY picky about the codec being EXACTLY
            // right here. Make sure you know which codecs you're using!
            sourceBuffer = mediaSource.addSourceBuffer('video/mp4; codecs="avc1.640028,mp4a.40.2"');

            // If we requested any video data prior to setting up the SourceBuffer,
            // we want to make sure we only append one blob at a time
            sourceBuffer.addEventListener("updateend", appendToSourceBuffer);

            // 5. Use `SourceBuffer.appendBuffer()` to add all of your chunks to the video
            function appendToSourceBuffer() {
                if (
                    mediaSource.readyState === "open" &&
                    sourceBuffer &&
                    sourceBuffer.updating === false
                ) {
                    const obj = arrayOfBlobs.shift()
                    console.log('ok')
                    //return
                    sourceBuffer.appendBuffer(obj);
                }
            }

            function getData(index) {
                fetch(`/video/test/${index}`)
                    .then(res => {
                        if (res.status !== 200) return null
                        else return res.arrayBuffer()
                    })
                    .then(data => {
                        if (data === null) return
                        arrayOfBlobs.push(data)
                        sourceBuffer.appendBuffer(data)
                        getData(index + 1)
                    })
            }
            getData(0)
        });*/

        /*var ms = new MediaSource();
        var video = document.getElementById('video');
        video.src = window.URL.createObjectURL(ms);
        ms.addEventListener('sourceopen', function (e) {
            var sourceBuffer = ms.addSourceBuffer('video/mp4; codecs="avc1.4d401f,mp4a.40.2"');
            function getData(index) {
                fetch(`/video/test/${index}`)
                    .then(res => {
                        if (res.status !== 200) return null
                        else return res.arrayBuffer()
                    })
                    .then(data => {
                        if (data === null) return
                        console.log('data: ', data)
                        sourceBuffer.appendBuffer(data);
                        getData(index+1)
                    })
            }
            getData(0)
        }, false);*/
    </script>
</body>

</html>